import 'package:flutter/material.dart';

void main() => runApp(AssistanceScolaireApp());

class AssistanceScolaireApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Assistance Scolaire',
      theme: ThemeData(primarySwatch: Colors.blue),
      home: HomeScreen(),
    );
  }
}

// ----------------------
// Écran principal
// ----------------------
class HomeScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      // Fond d'écran identique à l'ancienne version
      body: Container(
        decoration: BoxDecoration(
          image: DecorationImage(
            image: NetworkImage(
                'https://img.freepik.com/vecteurs-libre/fond-bulles-eau-brillante-fond-bleu_101'),
            fit: BoxFit.cover,
          ),
        ),
        child: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              ElevatedButton(
                child: Text('Quiz'),
                onPressed: () => Navigator.push(
                    context,
                    MaterialPageRoute(
                        builder: (_) => SubjectScreen(isQuiz: true))),
              ),
              ElevatedButton(
                child: Text('Flashcards'),
                onPressed: () => Navigator.push(
                    context,
                    MaterialPageRoute(
                        builder: (_) => SubjectScreen(isQuiz: false))),
              ),
              ElevatedButton(
                child: Text('Pomodoro'),
                onPressed: () => Navigator.push(
                    context, MaterialPageRoute(builder: (_) => PomodoroScreen())),
              ),
              ElevatedButton(
                child: Text('Tâches'),
                onPressed: () => Navigator.push(
                    context, MaterialPageRoute(builder: (_) => TasksScreen())),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

// ----------------------
// Sélection de matière
// ----------------------
class SubjectScreen extends StatelessWidget {
  final bool isQuiz;
  SubjectScreen({required this.isQuiz});

  final List<String> subjects = ['Math', 'Français', 'Anglais', 'Science'];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
          title: Text(isQuiz ? 'Choisir Matière - Quiz' : 'Choisir Matière - Flashcards')),
      body: ListView.builder(
        itemCount: subjects.length,
        itemBuilder: (context, index) {
          return ListTile(
            title: Text(subjects[index]),
            onTap: () {
              Navigator.push(
                  context,
                  MaterialPageRoute(
                      builder: (_) =>
                          CardScreen(subject: subjects[index], isQuiz: isQuiz)));
            },
          );
        },
      ),
    );
  }
}

// ----------------------
// Écran des cartes / quiz avec swipe
// ----------------------
class CardScreen extends StatefulWidget {
  final String subject;
  final bool isQuiz;
  CardScreen({required this.subject, required this.isQuiz});

  @override
  _CardScreenState createState() => _CardScreenState();
}

class _CardScreenState extends State<CardScreen> {
  List<String> cards = [];
  int currentIndex = 0;

  @override
  void initState() {
    super.initState();
    // Exemple de cartes/questions
    cards = List.generate(10, (i) => '${widget.subject} Question ${i + 1}');
  }

  void swipeRight() {
    nextCard();
  }

  void swipeLeft() {
    nextCard();
  }

  void nextCard() {
    if (currentIndex < cards.length - 1) {
      setState(() {
        currentIndex++;
      });
    } else {
      showDialog(
        context: context,
        builder: (_) => AlertDialog(
          title: Text('Terminé !'),
          content: Text('Vous avez terminé toutes les cartes de ${widget.subject}.'),
          actions: [
            TextButton(
              child: Text('OK'),
              onPressed: () => Navigator.popUntil(context, (route) => route.isFirst),
            ),
          ],
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
          title: Text('${widget.subject} - ${widget.isQuiz ? 'Quiz' : 'Flashcards'}')),
      body: Center(
        child: GestureDetector(
          onPanEnd: (details) {
            if (details.velocity.pixelsPerSecond.dx > 0) {
              swipeRight();
            } else {
              swipeLeft();
            }
          },
          child: Card(
            margin: EdgeInsets.all(20),
            child: Container(
              height: 300,
              alignment: Alignment.center,
              child: Text(cards[currentIndex], style: TextStyle(fontSize: 24)),
            ),
          ),
        ),
      ),
    );
  }
}

// ----------------------
// Pomodoro
// ----------------------
class PomodoroScreen extends StatefulWidget {
  @override
  _PomodoroScreenState createState() => _PomodoroScreenState();
}

class _PomodoroScreenState extends State<PomodoroScreen> {
  int minutes = 25;
  int seconds = 0;
  bool isRunning = false;
  late final Ticker _ticker;

  @override
  void initState() {
    super.initState();
    _ticker = Ticker((_) {
      if (isRunning) {
        setState(() {
          if (seconds == 0) {
            if (minutes == 0) {
              isRunning = false;
            } else {
              minutes--;
              seconds = 59;
            }
          } else {
            seconds--;
          }
        });
      }
    });
    _ticker.start();
  }

  @override
  void dispose() {
    _ticker.stop();
    super.dispose();
  }

  void startPause() => setState(() => isRunning = !isRunning);

  void reset() => setState(() {
        minutes = 25;
        seconds = 0;
        isRunning = false;
      });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Pomodoro')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text('${minutes.toString().padLeft(2, '0')}:${seconds.toString().padLeft(2, '0')}',
                style: TextStyle(fontSize: 60)),
            SizedBox(height: 20),
            ElevatedButton(onPressed: startPause, child: Text(isRunning ? 'Pause' : 'Démarrer')),
            ElevatedButton(onPressed: reset, child: Text('Réinitialiser')),
          ],
        ),
      ),
    );
  }
}

// ----------------------
// Tâches
// ----------------------
class TasksScreen extends StatefulWidget {
  @override
  _TasksScreenState createState() => _TasksScreenState();
}

class _TasksScreenState extends State<TasksScreen> {
  List<String> tasks = [];
  TextEditingController controller = TextEditingController();

  void addTask(String task) {
    if (task.trim().isEmpty) return;
    setState(() => tasks.add(task));
    controller.clear();
  }

  void removeTask(int index) => setState(() => tasks.removeAt(index));

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Tâches')),
      body: Column(
        children: [
          Padding(
            padding: EdgeInsets.all(8),
            child: Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: controller,
                    decoration: InputDecoration(labelText: 'Nouvelle tâche'),
                  ),
                ),
                IconButton(icon: Icon(Icons.add), onPressed: () => addTask(controller.text))
              ],
            ),
          ),
          Expanded(
            child: ListView.builder(
              itemCount: tasks.length,
              itemBuilder: (context, index) {
                return ListTile(
                  title: Text(tasks[index]),
                  trailing: IconButton(
                      icon: Icon(Icons.delete), onPressed: () => removeTask(index)),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

// ----------------------
// Ticker pour Pomodoro
// ----------------------
class Ticker {
  final void Function(Duration) onTick;
  bool _running = false;

  Ticker(this.onTick) {
    _tick();
  }

  void _tick() async {
    while (true) {
      await Future.delayed(Duration(seconds: 1));
      if (_running) onTick(Duration(seconds: 1));
    }
  }

  void start() => _running = true;
  void stop() => _running = false;
}
