import 'dart:convert';
import 'dart:math';
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

void main() => runApp(AssistanceScolaireApp());

class AssistanceScolaireApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Assistance Scolaire',
      theme: ThemeData(primarySwatch: Colors.blue),
      home: HomeScreen(),
    );
  }
}

// ----------------------
// Écran principal
// ----------------------
class HomeScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: BoxDecoration(
          image: DecorationImage(
            image: NetworkImage(
                'https://img.freepik.com/vecteurs-libre/fond-bulles-eau-brillante-fond-bleu_101'),
            fit: BoxFit.cover,
          ),
        ),
        child: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              ElevatedButton(
                  child: Text('Quiz'),
                  onPressed: () => Navigator.push(
                      context,
                      MaterialPageRoute(
                          builder: (_) => SubjectScreen(isQuiz: true)))),
              ElevatedButton(
                  child: Text('Flashcards'),
                  onPressed: () => Navigator.push(
                      context,
                      MaterialPageRoute(
                          builder: (_) => SubjectScreen(isQuiz: false)))),
              ElevatedButton(
                  child: Text('Pomodoro'),
                  onPressed: () =>
                      Navigator.push(context, MaterialPageRoute(builder: (_) => PomodoroScreen()))),
              ElevatedButton(
                  child: Text('Tâches'),
                  onPressed: () =>
                      Navigator.push(context, MaterialPageRoute(builder: (_) => TasksScreen()))),
            ],
          ),
        ),
      ),
    );
  }
}

// ----------------------
// Sélection de matière
// ----------------------
class SubjectScreen extends StatelessWidget {
  final bool isQuiz;
  SubjectScreen({required this.isQuiz});

  final List<String> subjects = ['Math', 'Français', 'Anglais', 'Science'];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
          title: Text(isQuiz ? 'Choisir Matière - Quiz' : 'Choisir Matière - Flashcards')),
      body: ListView.builder(
        itemCount: subjects.length,
        itemBuilder: (context, index) {
          return ListTile(
            title: Text(subjects[index]),
            onTap: () {
              Navigator.push(
                  context,
                  MaterialPageRoute(
                      builder: (_) =>
                          EnsembleListScreen(subject: subjects[index], isQuiz: isQuiz)));
            },
          );
        },
      ),
    );
  }
}

// ----------------------
// Liste des ensembles par matière
// ----------------------
class EnsembleListScreen extends StatefulWidget {
  final String subject;
  final bool isQuiz;
  EnsembleListScreen({required this.subject, required this.isQuiz});

  @override
  _EnsembleListScreenState createState() => _EnsembleListScreenState();
}

class _EnsembleListScreenState extends State<EnsembleListScreen> {
  List<String> ensembles = [];

  @override
  void initState() {
    super.initState();
    loadEnsembles();
  }

  void loadEnsembles() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    setState(() {
      ensembles = prefs.getStringList('${widget.subject}_${widget.isQuiz ? "quiz" : "flash"}') ?? [];
    });
  }

  void saveEnsembles() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    prefs.setStringList('${widget.subject}_${widget.isQuiz ? "quiz" : "flash"}', ensembles);
  }

  void addEnsemble(String title) {
    if (title.trim().isEmpty) return;
    setState(() => ensembles.add(title));
    saveEnsembles();
    saveEmptyCards(title);
  }

  void saveEmptyCards(String ensemble) async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    prefs.setStringList('${widget.subject}_$ensemble', []);
  }

  void removeEnsemble(int index) async {
    bool? confirm = await showDialog(
        context: context,
        builder: (_) => AlertDialog(
              title: Text('Supprimer cet ensemble ?'),
              content: Text('Êtes-vous sûr de vouloir le supprimer ?'),
              actions: [
                TextButton(onPressed: () => Navigator.pop(context, false), child: Text('Non')),
                TextButton(onPressed: () => Navigator.pop(context, true), child: Text('Oui')),
              ],
            ));
    if (confirm ?? false) {
      SharedPreferences prefs = await SharedPreferences.getInstance();
      await prefs.remove('${widget.subject}_${ensembles[index]}'); // supprime contenu
      setState(() {
        ensembles.removeAt(index);
        saveEnsembles();
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('${widget.subject} - ${widget.isQuiz ? "Quiz" : "Flashcards"}'),
      ),
      body: Column(
        children: [
          Padding(
            padding: EdgeInsets.all(8),
            child: ElevatedButton(
                child: Text('Créer un nouveau'),
                onPressed: () async {
                  TextEditingController ctrl = TextEditingController();
                  await showDialog(
                      context: context,
                      builder: (_) => AlertDialog(
                            title: Text('Titre de l’ensemble'),
                            content: TextField(controller: ctrl),
                            actions: [
                              TextButton(
                                  onPressed: () => Navigator.pop(context), child: Text('Annuler')),
                              TextButton(
                                  onPressed: () {
                                    addEnsemble(ctrl.text);
                                    Navigator.pop(context);
                                  },
                                  child: Text('Créer')),
                            ],
                          ));
                }),
          ),
          Expanded(
            child: ListView.builder(
              itemCount: ensembles.length,
              itemBuilder: (context, index) {
                return ListTile(
                  title: Text(ensembles[index]),
                  trailing: IconButton(
                      icon: Icon(Icons.delete),
                      onPressed: () => removeEnsemble(index)),
                  onTap: () {
                    Navigator.push(
                        context,
                        MaterialPageRoute(
                            builder: (_) => CardPlayScreen(
                                  subject: widget.subject,
                                  ensemble: ensembles[index],
                                  isQuiz: widget.isQuiz,
                                )));
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

// ----------------------
// CardPlayScreen (Flashcards & Quiz)
// ----------------------
class CardPlayScreen extends StatefulWidget {
  final String subject;
  final String ensemble;
  final bool isQuiz;
  CardPlayScreen({required this.subject, required this.ensemble, required this.isQuiz});

  @override
  _CardPlayScreenState createState() => _CardPlayScreenState();
}

class _CardPlayScreenState extends State<CardPlayScreen> {
  List<Map<String, dynamic>> cards = [];
  int currentIndex = 0;
  Map<int, bool> results = {};
  bool finished = false;

  @override
  void initState() {
    super.initState();
    loadCards();
  }

  void loadCards() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    List<String>? raw = prefs.getStringList('${widget.subject}_${widget.ensemble}');
    if (raw != null) {
      setState(() {
        cards = raw.map((e) => Map<String, dynamic>.from(jsonDecode(e))).toList();
      });
    }
  }

  void saveCards() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    prefs.setStringList('${widget.subject}_${widget.ensemble}',
        cards.map((e) => jsonEncode(e)).toList());
  }

  void markCard(bool correct) {
    results[currentIndex] = correct;
    nextCard();
  }

  void nextCard() {
    if (currentIndex < cards.length - 1) {
      setState(() => currentIndex++);
    } else {
      setState(() => finished = true);
    }
  }

  void restartErrors() {
    List<Map<String, dynamic>> newCards = [];
    for (var entry in results.entries) {
      if (!entry.value) newCards.add(cards[entry.key]);
    }
    setState(() {
      cards = newCards..shuffle();
      results = {};
      currentIndex = 0;
      finished = false;
    });
  }

  void restartAll() {
    setState(() {
      cards.shuffle();
      results = {};
      currentIndex = 0;
      finished = false;
    });
  }

  void addCard() async {
    TextEditingController questionCtrl = TextEditingController();
    List<TextEditingController> choiceCtrls =
        List.generate(4, (_) => TextEditingController());
    await showDialog(
        context: context,
        builder: (_) => AlertDialog(
              title: Text(widget.isQuiz ? 'Nouvelle question' : 'Nouvelle carte'),
              content: SingleChildScrollView(
                child: Column(
                  children: [
                    TextField(controller: questionCtrl, decoration: InputDecoration(labelText: 'Question / Carte')),
                    if (widget.isQuiz)
                      ...List.generate(4, (i) => TextField(controller: choiceCtrls[i], decoration: InputDecoration(labelText: 'Choix ${i+1}'))),
                  ],
                ),
              ),
              actions: [
                TextButton(onPressed: () => Navigator.pop(context), child: Text('Annuler')),
                TextButton(
                    onPressed: () {
                      Map<String, dynamic> card = {'question': questionCtrl.text};
                      if (widget.isQuiz) {
                        List<String> choix = [];
                        for (var c in choiceCtrls) if (c.text.trim().isNotEmpty) choix.add(c.text.trim());
                        card['choix'] = choix;
                        card['bonneReponse'] = choix.isNotEmpty ? choix[0] : '';
                      }
                      setState(() {
                        cards.add(card);
                        saveCards();
                      });
                      Navigator.pop(context);
                    },
                    child: Text('Ajouter')),
              ],
            ));
  }

  @override
  Widget build(BuildContext context) {
    if (cards.isEmpty) {
      return Scaffold(
        appBar: AppBar(
          title: Text(widget.ensemble),
          actions: [IconButton(icon: Icon(Icons.add), onPressed: addCard)],
        ),
        body: Center(child: Text('Aucune carte ou question')),
      );
    }

    if (finished) {
      int score = results.values.where((v) => v).length;
      return Scaffold(
        appBar: AppBar(
          title: Text(widget.ensemble),
          actions: [IconButton(icon: Icon(Icons.add), onPressed: addCard)],
        ),
        body: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text('Score : $score / ${cards.length}', style: TextStyle(fontSize: 24)),
              SizedBox(height: 20),
              ElevatedButton(onPressed: restartErrors, child: Text('Recommencer les erreurs')),
              ElevatedButton(onPressed: restartAll, child: Text('Tout recommencer')),
            ],
          ),
        ),
      );
    }

    var card = cards[currentIndex];

    if (widget.isQuiz) {
      List<String> choices = List<String>.from(card['choix'] ?? []);
      choices.shuffle(Random());
      return Scaffold(
        appBar: AppBar(
          title: Text(widget.ensemble),
          actions: [IconButton(icon: Icon(Icons.add), onPressed: addCard)],
        ),
        body: Padding(
          padding: EdgeInsets.all(16),
          child: Column(
            children: [
              Text(card['question'], style: TextStyle(fontSize: 24)),
              SizedBox(height: 20),
              ...choices.map((c) => ElevatedButton(
                  onPressed: () => markCard(c == card['bonneReponse']), child: Text(c))),
            ],
          ),
        ),
      );
    } else {
      return Scaffold(
        appBar: AppBar(
          title: Text(widget.ensemble),
          actions: [IconButton(icon: Icon(Icons.add), onPressed: addCard)],
        ),
        body: GestureDetector(
          onPanEnd: (details) {
            if (details.velocity.pixelsPerSecond.dx > 0) {
              markCard(true);
            } else {
              markCard(false);
            }
          },
          child: Center(
            child: Card(
              margin: EdgeInsets.all(20),
              color: results[currentIndex] == true ? Colors.green[100] : Colors.white,
              child: Container(
                height: 300,
                alignment: Alignment.center,
                child: Text(card['question'], style: TextStyle(fontSize: 24)),
              ),
            ),
          ),
        ),
      );
    }
  }
}

// ----------------------
// Pomodoro
// ----------------------
class PomodoroScreen extends StatefulWidget {
  @override
  _PomodoroScreenState createState() => _PomodoroScreenState();
}

class _PomodoroScreenState extends State<PomodoroScreen> {
  int minutes = 25;
  int seconds = 0;
  bool running = false;
  @override
  void initState() {
    super.initState();
    loadPomodoro();
  }

  void loadPomodoro() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    setState(() {
      minutes = prefs.getInt('pomodoro_minutes') ?? 25;
      seconds = prefs.getInt('pomodoro_seconds') ?? 0;
      running = prefs.getBool('pomodoro_running') ?? false;
    });
  }

  void savePomodoro() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    prefs.setInt('pomodoro_minutes', minutes);
    prefs.setInt('pomodoro_seconds', seconds);
    prefs.setBool('pomodoro_running', running);
  }

  void toggleTimer() => setState(() => running = !running);
  void resetTimer() => setState(() {
        minutes = 25;
        seconds = 0;
        running = false;
        savePomodoro();
      });

  @override
  Widget build(BuildContext context) {
    String minStr = minutes.toString().padLeft(2, '0');
    String secStr = seconds.toString().padLeft(2, '0');
    return Scaffold(
      appBar: AppBar(title: Text('Pomodoro')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text('$minStr:$secStr', style: TextStyle(fontSize: 48)),
            SizedBox(height: 20),
            ElevatedButton(onPressed: toggleTimer, child: Text(running ? 'Pause' : 'Démarrer')),
            ElevatedButton(onPressed: resetTimer, child: Text('Réinitialiser')),
          ],
        ),
      ),
    );
  }
}

// ----------------------
// Tâches
// ----------------------
class TasksScreen extends StatefulWidget {
  @override
  _TasksScreenState createState() => _TasksScreenState();
}

class _TasksScreenState extends State<TasksScreen> {
  List<String> tasks = [];
  TextEditingController controller = TextEditingController();

  @override
  void initState() {
    super.initState();
    loadTasks();
  }

  void loadTasks() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    setState(() {
      tasks = prefs.getStringList('tasks') ?? [];
    });
  }

  void saveTasks() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    prefs.setStringList('tasks', tasks);
  }

  void addTask(String t) {
    if (t.trim().isEmpty) return;
    setState(() => tasks.add(t));
    saveTasks();
    controller.clear();
  }

  void removeTask(int index) {
    setState(() => tasks.removeAt(index));
    saveTasks();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Tâches')),
      body: Column(
        children: [
          Padding(
            padding: EdgeInsets.all(8),
            child: Row(
              children: [
                Expanded(child: TextField(controller: controller, decoration: InputDecoration(labelText: 'Nouvelle tâche'))),
                IconButton(icon: Icon(Icons.add), onPressed: () => addTask(controller.text)),
              ],
            ),
          ),
          Expanded(
              child: ListView.builder(
            itemCount: tasks.length,
            itemBuilder: (context, index) => ListTile(
              title: Text(tasks[index]),
              trailing: IconButton(icon: Icon(Icons.delete), onPressed: () => removeTask(index)),
            ),
          ))
        ],
      ),
    );
  }
}
